# Emerging Markets: Risk, Returns, and Portfolio Integration

## 1. Concept Skeleton
**Definition:** Equities and bonds in developing/rapidly-growing economies with higher growth potential, higher volatility, and distinct risk factors (political risk, currency volatility, market illiquidity, structural changes) relative to developed markets  
**Purpose:** Quantify EM return premiums, understand EM-specific risks (currency crashes, capital controls, government intervention), determine optimal EM allocation in global portfolios  
**Prerequisites:** Market segmentation, risk premiums, currency risk, emerging market indicators (sovereign ratings, capital flows)

---

## 2. Comparative Framing

| Characteristic | Developed Markets (US, Europe, Japan) | Emerging Markets (China, India, Brazil) | Frontier Markets (Vietnam, Bangladesh) |
|----------------|---------------------------------------|----------------------------------------|---------------------------------------|
| **Long-term Equity Return** | ~9-10% p.a. | ~12-15% p.a. | ~15-20% p.a. (if successful) |
| **Volatility** | 15-18% p.a. | 20-25% p.a. | 30-40% p.a. |
| **Currency Volatility** | 5-8% p.a. (developed) | 10-15% p.a. (EM) | 15-25% p.a. (frontier) |
| **Sharpe Ratio** | 0.50-0.65 | 0.40-0.60 | 0.30-0.50 |
| **Growth Rate (GDP)** | 2-3% p.a. | 5-8% p.a. | 6-10% p.a. |
| **Inflation Rate** | 2-3% p.a. | 4-7% p.a. | 5-12% p.a. |
| **P/E Ratios** | 15-20x | 12-18x (cheap, but for reason) | 8-15x (super cheap, high risk) |
| **Market Cap as % of Global** | 70% | 25% | 2-3% |
| **Liquidity Risk** | Very liquid | Medium (variable by country) | Illiquid (hard to exit large positions) |
| **Currency Crisis Frequency** | Rare (2020s) | 1-2 per decade per country | 3-5 per decade (frequent) |
| **Sovereign Default Frequency** | Never (last 50y) | Argentina 2001, Lebanon 2020 | Multiple (Nigeria, Egypt, others) |
| **Political Risk** | Low | Medium-High | Very High |
| **Correlation with US Stocks** | 0.80-0.95 | 0.60-0.75 | 0.20-0.50 |
| **Optimal Portfolio Allocation** | 35-50% | 15-25% | <5% (illiquid) |

**Key Insight:** EM returns driven by two engines: (1) GDP growth (real earnings growth), (2) valuation multiple expansion (as markets integrate globally). Frontier markets offer even higher return potential but with outsized risks.

---

## 3. Examples + Counterexamples

**Example 1: China's Multi-Decade EM Story (1990-2020)**
- 1990 Shanghai Stock Exchange reopens: 43 stocks
- 2000-2010: Chinese equities +400% (GDP growth ~9% p.a., multiple expansion from 5x to 15x earnings)
- 2010-2020: Chinese equities +200% (GDP growth ~6% p.a., multiple stable at 12-15x)
- Long-term result: Extraordinary wealth creation (+1,000% over 30 years)
- Drivers: Multiple expansion from opening market, high growth, relative cheapness
- Risk: Lost during 2015 (Shanghai crash -43%), 2008 (global crisis -65%), 2022 (tech regulation -35%)
- Lesson: EM exceptional returns require (1) structural growth, (2) willingness to endure drawdowns, (3) long holding period

**Example 2: India's Recent Outperformance (2015-2024)**
- 2015: India considered undervalued (P/E ~15x, GDP growth 7%)
- 2024: India strongest MSCI EM contributor (+20% return in 2023, +10% in 2024)
- Drivers: Consistent GDP growth (6-7%), demographics (median age 27), manufacturing shift from China
- Returns: India contributed ~40% of EM index total return despite only 15% weight
- Lesson: EM returns concentrated in high-growth economies; diversification within EM important

**Example 3: Brazil Currency Crisis & Commodity Collapse (2014-2016)**
- 2014: Brazil attractive (P/E 12x, commodity dividend expected)
- 2014-2016: Brazilian Real collapsed -60% vs USD (commodity prices halved)
- Equity return in USD: -50% (local equity -30% + currency -60%, compounded)
- Impact: Unhedged Brazilian investor lost massive wealth on currency depreciation alone
- Lesson: EM currency risk real; commodity-exporters especially vulnerable to commodity price shocks

**Example 4: Russia Invasion (Feb 2022)**
- Pre-invasion: Russia in MSCI EM index (3% weight)
- Feb 24 invasion → Markets halted (no price discovery possible)
- Result: Russian equities -99% (essentially zero value)
- Portfolio impact: Small due to low weight, but devastating for Russian investors
- Lesson: Political risk tails; index exposure limits individual country concentration

**Counterexample: Argentina's Lost Decade (2000-2020)**
- Argentina peaked in 1990s as "Tiger Economy"
- 2001 Crisis: Currency peg breaks, peso collapses -75%
- 2020: Long-term USD returns essentially zero despite nominal GDP growth
- Returns consumed by: Currency depreciation (-75%), default (debt repudiation -50%), capital controls (trapped money)
- Lesson: Growth statistics misleading; currency risk and capital structure (debt level) critical

**Edge Case: Valuation Trap (Cheap Doesn't Always Get Cheaper)**
- 2010: China's P/E ratio 11x vs US 15x (seemingly cheap)
- 2010-2020: Chinese multiples re-rated to 15x (expensive); US stayed 15x
- If you bought "cheap" China and sold "expensive" US: Suffered valuation compression
- Lesson: Low P/E in EM sometimes reflects genuine problems (governance, capital flows, political risk) not just opportunity

---

## 4. Layer Breakdown

```
Emerging Markets Architecture:

├─ Classification Tiers:
│   ├─ Developed Markets (US, Europe, Japan, Australia):
│   │   └─ Mature economies, deep markets, strong institutions
│   │
│   ├─ Emerging Markets (Brazil, Mexico, India, China, Russia, S. Africa):
│   │   ├─ Upper tier: Size + development (China, India have 40% of MSCI EM weight)
│   │   ├─ Middle tier: Latin America, Asian tigers (Mexico, Korea, Indonesia)
│   │   └─ Lower tier: Vietnam, Philippines, Pakistan
│   │
│   └─ Frontier Markets (Vietnam, Bangladesh, Egypt, Kenya):
│       └─ Small, illiquid, ultra-high risk but potential 30%+ returns
│
├─ Return Sources in Emerging Markets:
│   ├─ Earnings Growth (fundamental):
│   │   ├─ GDP growth: EM 6-8% vs DM 2-3%
│   │   ├─ Profit margin expansion: EMs benefit from scale (e.g., Indian tech)
│   │   └─ Capitalization: Shift to market-based capitalism rewards early movers
│   │
│   ├─ Multiple Expansion (valuation re-rating):
│   │   ├─ Liberalization: EM opens to foreign capital → P/E rises from 8x to 12x
│   │   ├─ Index inclusion: Company added to MSCI EM → passive inflows boost price
│   │   └─ Credit rating upgrade: Emerging bond upgraded to investment grade → capital influx
│   │   └─ Historical: China (1990s) and India (2000s) saw massive multiple expansion
│   │
│   ├─ Currency Appreciation:
│   │   ├─ If local currency strengthens: Adds to unhedged USD returns
│   │   ├─ Typical: EM currencies depreciate over time (inflation differential)
│   │   └─ Example: Brazilian Real strengthened 2003-2008 (commodity boom), then collapsed 2013-2015
│   │
│   ├─ Commodity/Sector Exposure:
│   │   ├─ Commodity exporters (Brazil, Russia, S. Africa, Indonesia): Leverage to commodity prices
│   │   ├─ Tech exporters (India, Philippines): Leverage to global demand
│   │   └─ Diversification: EM index inherently diversified across commodity/growth exposures
│   │
│   └─ Coupon/Dividend Yield:
│       ├─ EM equities: 2-3% dividend yield
│       ├─ EM bonds: 4-6% yield (vs 3-4% for US Treasuries)
│       └─ Attracts carry traders; carry reversal risk in crisis
│
├─ Risk Sources Unique to Emerging Markets:
│   ├─ Currency Risk:
│   │   ├─ EM currencies exhibit high volatility (10-15% p.a.)
│   │   ├─ Typical pattern: Appreciate during booms (commodity rally, growth), collapse during crises (capital flight)
│   │   ├─ Unhedged EM equity return = Local return (±15%) + FX return (±10%) = ±24% volatility
│   │   └─ Example: Brazil 2015-2016 currency crash added -60% to local stock performance
│   │
│   ├─ Political & Sovereign Risk:
│   │   ├─ Government intervention: Price controls, capital controls, nationalization
│   │   ├─ Electoral risk: New government reverses economic policies
│   │   ├─ Corruption: Theft of shareholder value through state capture
│   │   └─ Historical: Argentina repeated default (1989, 2001, 2020s); Russia sanctions (2022)
│   │
│   ├─ Market Liquidity Risk:
│   │   ├─ Thin order books: Large positions move market 2-5%
│   │   ├─ Trading halts: Extreme volatility triggers halt (Russia 2022)
│   │   ├─ Capital controls: Some countries restrict foreign capital withdrawal (China periodically)
│   │   └─ Illiquidity premium: Investors demand 2-3% extra return for illiquidity
│   │
│   ├─ Commodity Dependency:
│   │   ├─ Brazil, Russia, S. Africa: 30-50% of revenues from commodity exports
│   │   ├─ Commodity crash → Currency crisis + recession → Equities crash + corporate defaults
│   │   └─ Example: Brazil 2014-2016 (oil + commodities -50% globally → BRL -60%, BOVESPA -65%)
│   │
│   ├─ Capital Flow Volatility:
│   │   ├─ EM assets vulnerable to sudden reversals (foreign investors flee)
│   │   ├─ Contagion: Crisis in Brazil → capital flight from all EM → correlation spike
│   │   ├─ Carry trade unwinding: Investors borrow yen at 0%, invest in EM at 8%, then reverse → forced selling
│   │   └─ Frequency: Major EM crisis every 3-5 years (1997 Asian crisis, 1998 Russia, 2008 Global, 2013 Taper Tantrum)
│   │
│   ├─ Governance & Quality Risk:
│   │   ├─ Accounting standards: GAAP-equivalent but sometimes lax enforcement
│   │   ├─ Minority shareholder protection: Weak in some EM (related-party transactions common)
│   │   ├─ Fraud risk: Greater potential for corporate fraud (e.g., Satyam in India)
│   │   └─ Sustainability: High growth sometimes at expense of labor/environmental standards
│   │
│   └─ Valuation Risk:
│       ├─ Cheap can get cheaper: Low P/E doesn't mean cheap (reflects genuine risks)
│       ├─ Mean reversion: P/E 8x may compress to 6x during downturn (happened to Russia pre-2022)
│       └─ Selection bias: Published EM returns include survivorship (failed markets exclude)
│
├─ Valuation and Cyclicality:
│   ├─ EM typically cycles between Undervalued → Boom → Overvalued → Crash → Undervalued
│   │   ├─ Undervalued (opportunity): 2008-2009 post-crisis, 2015-2016 post-taper tantrum
│   │   ├─ Boom: 2003-2007 (commodity boom), 2017-2018 (late cycle)
│   │   ├─ Overvalued: 2007 (before crash), 2021 (AI/tech hype)
│   │   └─ Crash: 2008, 2015-2016, 2020 COVID, 2022 (Russia)
│   │
│   ├─ Timing EM Allocation:
│   │   ├─ Optimal entry: When P/E < 12x AND spreading widening >250bps (fear)
│   │   ├─ Reduce exposure: When P/E > 18x AND spreads <100bps (greed)
│   │   └─ Range: Stay 15-25% allocation through cycles (over/underweight as valuations change)
│   │
│   └─ Role in Portfolio:
│       ├─ Strategic allocation: 15-25% for growth-oriented portfolios
│       ├─ Tactical overlay: Increase to 30% when valuation attractive, reduce to 10% when overheated
│       └─ Hedge: EM currencies sometimes negative correlation to US (capital flight to safety)
│
└─ Implementation Considerations:
    ├─ Passive (Index) vs Active:
    │   ├─ Passive: Track MSCI EM index (concentration in top 5: China 35%, India 15%, Taiwan 15%, Brazil 8%, S. Africa 5%)
    │   ├─ Active: Sector/country positioning, stock picking, currency hedging
    │   └─ Evidence: Active EM managers underperform index 70% of time (fees drag)
    │
    ├─ Hedging Decisions:
    │   ├─ Unhedged: Accept 10-15% FX volatility; long-term benefits
    │   ├─ Hedged: Remove FX; costs 2-3% p.a. (typically not worthwhile)
    │   ├─ Selective: Hedge high-risk currencies (Turkish Lira, Argentine Peso) if large allocation
    │   └─ Dynamic: Hedge more during crisis (when correlation high)
    │
    ├─ Valuation Metrics to Monitor:
    │   ├─ MSCI EM P/E ratio: Buy <12x, sell >18x
    │   ├─ Emerging Market spreads: Buy >250bps, sell <100bps (vs US Treasuries)
    │   ├─ Currency: Monitor for extreme devaluation signals
    │   └─ VIX + MOVE index: High volatility = potential opportunity (capitulation)
    │
    └─ Concentration Risk:
        ├─ China + India = 50% of MSCI EM (massive concentration risk)
        ├─ Recommendation: Use broad EM index or actively diversify within EM
        └─ Alternative: Country-specific ETFs for tactical allocation
```

**Mathematical Formulas:**

EM Return Decomposition (unhedged):
$$R_{EM,USD} = (1 + R_{local})(1 + R_{FX}) - 1$$
$$R_{EM,USD} \approx R_{local} + R_{FX} + R_{local} \cdot R_{FX}$$

Where $R_{local}$ = local currency return (stock performance) and $R_{FX}$ = currency appreciation

EM Volatility (accounting for currency):
$$\sigma^2_{EM,USD} = \sigma^2_{local} + \sigma^2_{FX} + 2\rho_{local,FX} \sigma_{local} \sigma_{FX}$$

If σ_local = 22%, σ_FX = 12%, ρ = +0.3:
$$\sigma_{EM,USD}^2 = 0.22^2 + 0.12^2 + 2(0.3)(0.22)(0.12) = 0.0484 + 0.0144 + 0.0158 = 0.0786$$
$$\sigma_{EM,USD} = 28\%$$ (higher than local volatility due to FX)

Risk Premium Decomposition (relative to US Treasuries):
$$E[R_{EM}] - R_f = \beta_{market} (E[R_m] - R_f) + \text{Size Premium} + \text{Illiquidity Premium} + \text{Political Risk Premium} + \text{Error}$$

Typical breakdown for EM equity:
- Market beta: ~0.90 × 5% = 4.5%
- EM premium (size + illiquidity + political): ~2.5-3.5%
- Total: ~7-8% excess return expected (vs 5% for US equity)

---

## 5. Mini-Project: EM Valuation & Crisis Detection Model

```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime
import yfinance as yf

# Build an EM valuation model to identify buy/sell opportunities and crisis risk

def get_em_data(start_date, end_date):
    """
    Fetch MSCI Emerging Markets data and constituent countries.
    """
    # Main EM indices
    indices = {
        'EEM': 'MSCI Emerging Markets ETF',
        'VWO': 'Vanguard MSCI EM ETF',
        # Individual countries (proxies)
        'ASHR': 'China (Arca)',
        'INDY': 'India (Arca)',
        'EWZ': 'Brazil iShares',
        'ERUS': 'Russia iShares',
        'RSX': 'Russia iShares (alt)',
        'MXEA': 'Mexico iShares',
        'EWW': 'Mexico iShares (alt)',
    }
    
    data = yf.download([k for k in indices.keys() if k not in ['ERUS', 'RSX', 'EWW']], 
                       start=start_date, end=end_date, progress=False)['Adj Close']
    
    returns = data.pct_change().dropna()
    return returns, indices


def calculate_valuation_metrics(prices, start_date, end_date):
    """
    Estimate EM valuation using price-to-book and earnings yield proxies.
    Use rolling correlations as risk indicator.
    """
    # Approximate P/E from historical returns + dividend yield
    # Cannot calculate true P/E from just prices, so use volatility and correlation as proxies
    
    # Calculate rolling 252-day volatility
    rolling_vol = prices.rolling(252).std() * np.sqrt(252)
    
    # Calculate rolling correlation with S&P 500
    if 'SPY' not in prices.columns:
        spy_data = yf.download('SPY', start=start_date, end=end_date, progress=False)['Adj Close']
        prices_with_spy = prices.copy()
        prices_with_spy['SPY'] = spy_data
    else:
        prices_with_spy = prices
    
    returns_all = prices_with_spy.pct_change().dropna()
    
    rolling_corr_sp = {}
    for col in ['EEM', 'ASHR', 'INDY', 'EWZ']:
        if col in returns_all.columns:
            rolling_corr_sp[f'{col}_Corr_SPY'] = returns_all[col].rolling(252).corr(returns_all['SPY'])
    
    return rolling_vol, rolling_corr_sp


def EM_crisis_score(rolling_vol, rolling_corr, lookback=252):
    """
    Calculate crisis risk score:
    - High volatility (>25%)
    - High correlation (>0.85) with US stocks
    - Both indicate contagion/crisis risk
    """
    crisis_scores = {}
    
    for col in rolling_vol.columns:
        if col in ['EEM', 'ASHR', 'INDY', 'EWZ']:
            vol = rolling_vol[col]
            
            # Get correlation if available
            corr_col = f'{col}_Corr_SPY'
            if corr_col in rolling_corr:
                corr = rolling_corr[corr_col]
            else:
                corr = 0.75  # Default if not available
            
            # Crisis score: (vol - mean) / std + (corr - mean) / std
            vol_z = (vol - vol.mean()) / vol.std()
            corr_z = (corr - corr.mean()) / (corr.std() if corr.std() > 0 else 1)
            
            crisis_scores[f'{col}_CrisisScore'] = 0.5 * vol_z + 0.5 * corr_z
    
    return pd.DataFrame(crisis_scores)


def valuation_buy_sell_signals(prices, lookback=252):
    """
    Generate buy/sell signals based on:
    1. Price below 200-day MA (oversold)
    2. Price above 200-day MA + high volatility (overbought + risk)
    """
    signals = {}
    
    for col in prices.columns:
        ma_200 = prices[col].rolling(200).mean()
        vol_20 = prices[col].pct_change().rolling(20).std() * np.sqrt(252)
        
        # Signal: -1 = strong sell, 0 = neutral, +1 = strong buy
        signal = np.zeros(len(prices))
        
        signal[prices[col] < 0.9 * ma_200] = 1  # Oversold: buy
        signal[prices[col] > 1.1 * ma_200] = -1  # Overbought: sell
        
        # Adjust by volatility regime
        signal[vol_20 > 0.30] *= 1.5  # High vol increases signal strength
        
        signals[f'{col}_Signal'] = signal
    
    return pd.DataFrame(signals, index=prices.index)


def calculate_performance_by_regime(returns, crisis_scores):
    """
    Analyze returns during different market regimes (normal vs crisis).
    """
    # Define crisis regime: Crisis score > 1 std above mean
    crisis_threshold = crisis_scores.mean() + crisis_scores.std()
    
    regimes = {}
    for col in crisis_scores.columns:
        col_base = col.replace('_CrisisScore', '')
        if col_base in returns.columns:
            
            # Mark crisis periods
            is_crisis = crisis_scores[col] > crisis_threshold[col]
            
            # Calculate returns in each regime
            normal_return = returns.loc[~is_crisis, col_base].mean() * 252
            crisis_return = returns.loc[is_crisis, col_base].mean() * 252
            normal_vol = returns.loc[~is_crisis, col_base].std() * np.sqrt(252)
            crisis_vol = returns.loc[is_crisis, col_base].std() * np.sqrt(252)
            
            regimes[col_base] = {
                'Normal Return': normal_return,
                'Normal Vol': normal_vol,
                'Crisis Return': crisis_return,
                'Crisis Vol': crisis_vol,
                'Crisis Freq': is_crisis.sum() / len(is_crisis)
            }
    
    return pd.DataFrame(regimes).T


# Main Analysis
print("=" * 100)
print("EMERGING MARKETS VALUATION & CRISIS DETECTION")
print("=" * 100)

# Get 10 years of data
prices, indices = get_em_data('2014-01-01', '2024-01-01')

# 1. Volatility analysis
print("\n1. VOLATILITY PATTERNS: EM vs US")
print("-" * 100)

rolling_vol, rolling_corr_dict = calculate_valuation_metrics(prices, '2014-01-01', '2024-01-01')

latest_vol = rolling_vol.iloc[-1]
print(f"Current Volatility (Latest):")
for idx, vol in latest_vol.items():
    print(f"  {idx}: {vol:.2%}")

print(f"\nHistorical Volatility (Mean/Min/Max):")
for col in rolling_vol.columns:
    mean_v = rolling_vol[col].mean()
    min_v = rolling_vol[col].min()
    max_v = rolling_vol[col].max()
    print(f"  {col}: {mean_v:.2%} (range {min_v:.2%} - {max_v:.2%})")

# 2. Correlation analysis
print("\n2. CORRELATION WITH US STOCKS: Contagion Indicator")
print("-" * 100)

rolling_corr_df = pd.DataFrame(rolling_corr_dict)
latest_corr = rolling_corr_df.iloc[-1]
print(f"Current Correlations (Latest):")
for idx, corr in latest_corr.items():
    print(f"  {idx}: {corr:.3f}")

print(f"\nHistorical Correlations (Mean/Min/Max):")
for col in rolling_corr_df.columns:
    mean_c = rolling_corr_df[col].mean()
    min_c = rolling_corr_df[col].min()
    max_c = rolling_corr_df[col].max()
    status = "HIGH" if mean_c > 0.80 else "MODERATE" if mean_c > 0.65 else "LOW"
    print(f"  {col}: {mean_c:.3f} (range {min_c:.3f} - {max_c:.3f}) [{status}]")

# 3. Performance by regime
print("\n3. PERFORMANCE IN NORMAL vs CRISIS REGIMES")
print("-" * 100)

crisis_scores = EM_crisis_score(rolling_vol, rolling_corr_df)
returns = prices.pct_change().dropna()

perf_by_regime = calculate_performance_by_regime(returns, crisis_scores)
print(perf_by_regime.round(4))

# 4. Buy/sell signals
print("\n4. VALUATION SIGNALS (Based on Price vs 200-day MA)")
print("-" * 100)

signals_df = valuation_buy_sell_signals(prices)
latest_signals = signals_df.iloc[-1]

print(f"Current Signals:")
for idx, sig in latest_signals.items():
    idx_base = idx.replace('_Signal', '')
    if sig > 0.5:
        action = "STRONG BUY"
    elif sig > 0:
        action = "BUY"
    elif sig < -0.5:
        action = "STRONG SELL"
    elif sig < 0:
        action = "SELL"
    else:
        action = "NEUTRAL"
    
    print(f"  {idx_base}: {action} (score: {sig:.2f})")

# 5. Crisis periods historical
print("\n5. HISTORICAL CRISIS PERIODS (EEM Index)")
print("-" * 100)

crisis_threshold_eem = crisis_scores['EEM_CrisisScore'].mean() + crisis_scores['EEM_CrisisScore'].std()
crisis_periods = crisis_scores[crisis_scores['EEM_CrisisScore'] > crisis_threshold_eem]

print(f"Crisis Score Threshold: {crisis_threshold_eem:.2f}")
print(f"Days in Crisis (>threshold): {len(crisis_periods)} days ({len(crisis_periods)/len(crisis_scores)*100:.1f}%)")
print(f"\nMajor Crisis Dates:")

# Find crisis clusters
if len(crisis_periods) > 0:
    crisis_dates = crisis_periods.index
    for crisis_date in crisis_dates[-20:]:  # Last 20 crisis signals
        return_day = returns.loc[crisis_date, 'EEM'] if crisis_date in returns.index else np.nan
        print(f"  {crisis_date.strftime('%Y-%m-%d')}: Score={crisis_scores.loc[crisis_date, 'EEM_CrisisScore']:.2f}, Return={return_day:.2%}")

# 6. Visualization
fig, axes = plt.subplots(2, 3, figsize=(16, 10))

# Plot 1: Rolling volatility
ax = axes[0, 0]
for col in ['EEM', 'ASHR', 'INDY']:
    if col in rolling_vol.columns:
        ax.plot(rolling_vol.index, rolling_vol[col], label=col, linewidth=2, alpha=0.8)
ax.axhline(0.25, color='red', linestyle='--', label='High Vol (25%)')
ax.axhline(0.15, color='green', linestyle='--', label='Low Vol (15%)')
ax.set_title('Rolling 252-Day Volatility', fontweight='bold')
ax.set_ylabel('Volatility')
ax.legend(fontsize=8)
ax.grid(alpha=0.3)

# Plot 2: Rolling correlations
ax = axes[0, 1]
for col in rolling_corr_df.columns:
    ax.plot(rolling_corr_df.index, rolling_corr_df[col], label=col.replace('_Corr_SPY', ''), linewidth=2, alpha=0.8)
ax.axhline(0.85, color='red', linestyle='--', label='Crisis (0.85+)')
ax.axhline(0.70, color='orange', linestyle='--', label='Normal (0.70)')
ax.set_title('Correlation with US Stocks (Crisis Indicator)', fontweight='bold')
ax.set_ylabel('Correlation')
ax.legend(fontsize=8)
ax.grid(alpha=0.3)
ax.set_ylim(0, 1)

# Plot 3: Crisis score
ax = axes[0, 2]
crisis_score_eem = crisis_scores['EEM_CrisisScore']
ax.plot(crisis_score_eem.index, crisis_score_eem, linewidth=2, color='steelblue')
ax.fill_between(crisis_score_eem.index, 0, crisis_score_eem, 
                 where=(crisis_score_eem > crisis_threshold_eem), 
                 alpha=0.3, color='red', label='Crisis Zone')
ax.axhline(crisis_threshold_eem, color='red', linestyle='--', label='Threshold')
ax.set_title('EM Crisis Score (EEM)', fontweight='bold')
ax.set_ylabel('Crisis Score (z-score)')
ax.legend(fontsize=8)
ax.grid(alpha=0.3)

# Plot 4: Price vs 200-day MA
ax = axes[1, 0]
ax.plot(prices.index, prices['EEM'], label='EEM Price', linewidth=2)
ma_200 = prices['EEM'].rolling(200).mean()
ax.plot(ma_200.index, ma_200, label='200-day MA', linewidth=2, linestyle='--')
ax.fill_between(prices.index, 0.9*ma_200, 1.1*ma_200, alpha=0.2, color='gray', label='Buy/Sell Zone')
ax.set_title('EEM Price vs 200-Day Moving Average', fontweight='bold')
ax.set_ylabel('Price')
ax.legend(fontsize=8)
ax.grid(alpha=0.3)

# Plot 5: Performance by regime
ax = axes[1, 1]
regimes_to_plot = perf_by_regime[['Normal Return', 'Crisis Return']].sort_values('Normal Return')
x = np.arange(len(regimes_to_plot))
width = 0.35
ax.bar(x - width/2, regimes_to_plot['Normal Return'] * 100, width, label='Normal Regime', alpha=0.8)
ax.bar(x + width/2, regimes_to_plot['Crisis Return'] * 100, width, label='Crisis Regime', alpha=0.8)
ax.set_ylabel('Annual Return (%)')
ax.set_title('Returns by Market Regime', fontweight='bold')
ax.set_xticks(x)
ax.set_xticklabels(regimes_to_plot.index, fontsize=8)
ax.legend()
ax.grid(alpha=0.3, axis='y')

# Plot 6: Volatility comparison
ax = axes[1, 2]
volatility_comparison = perf_by_regime[['Normal Vol', 'Crisis Vol']]
x = np.arange(len(volatility_comparison))
width = 0.35
ax.bar(x - width/2, volatility_comparison['Normal Vol'] * 100, width, label='Normal Vol', alpha=0.8)
ax.bar(x + width/2, volatility_comparison['Crisis Vol'] * 100, width, label='Crisis Vol', alpha=0.8)
ax.set_ylabel('Volatility (%)')
ax.set_title('Volatility in Different Regimes', fontweight='bold')
ax.set_xticks(x)
ax.set_xticklabels(volatility_comparison.index, fontsize=8)
ax.legend()
ax.grid(alpha=0.3, axis='y')

plt.tight_layout()
plt.savefig('em_valuation_crisis_model.png', dpi=300, bbox_inches='tight')
print("\n✓ Chart saved: em_valuation_crisis_model.png")
plt.show()

# 7. EM allocation recommendation
print("\n6. EM ALLOCATION FRAMEWORK")
print("-" * 100)

current_vol_eem = rolling_vol['EEM'].iloc[-1]
current_corr_eem = rolling_corr_df['EEM_Corr_SPY'].iloc[-1]
current_price = prices['EEM'].iloc[-1]
ma_200_current = prices['EEM'].rolling(200).mean().iloc[-1]

print(f"""
CURRENT CONDITIONS (as of {prices.index[-1].strftime('%Y-%m-%d')}):
├─ EEM Volatility: {current_vol_eem:.2%}
├─ EEM-US Correlation: {current_corr_eem:.3f}
├─ Price vs 200-MA: {current_price / ma_200_current:.2%}
└─ Crisis Score: {crisis_scores['EEM_CrisisScore'].iloc[-1]:.2f}

ALLOCATION RECOMMENDATION:
├─ Volatility-adjusted:
│   ├─ If vol < 15%: Increase EM to 25-30% (low risk environment)
│   ├─ If vol 15-25%: Target 20% (normal)
│   ├─ If vol > 25%: Reduce to 10-15% (crisis risk)
│
├─ Correlation-adjusted:
│   ├─ If corr < 0.70: Increase EM (great diversification benefit)
│   ├─ If corr 0.70-0.80: Normal 20% allocation
│   ├─ If corr > 0.85: Reduce EM (diversification lost; contagion risk)
│
├─ Valuation-adjusted:
│   ├─ If price < 0.90 × MA200: Increase EM (oversold opportunity)
│   ├─ If price 0.90-1.10 × MA200: Maintain allocation
│   ├─ If price > 1.10 × MA200: Reduce EM (overextended)
│
└─ COMBINED RECOMMENDATION:
    ├─ Bullish case (low vol, low corr, oversold): 30% EM
    ├─ Normal case (moderate metrics): 20% EM
    └─ Bearish case (high vol, high corr, extended): 10% EM
""")

print("=" * 100)
```

---

## 6. Challenge Round

1. **EM Currency Gamble:** You allocate to Brazilian stocks unhedged. Local returns +15% but BRL weakens 20% vs USD. Net USD return: -8%. If you had hedged currency, return would be +15%. Should you hedge? What if hedging costs 2%? When would you hedge vs not hedge?

2. **Contagion Risk Paradox:** India (fundamentals strong: 6% GDP growth, tech exports rising) correlates with Brazil (commodity crisis). Why would India move with Brazil? What structural factors explain EM contagion despite different fundamentals?

3. **Multiple Expansion Trap:** EM P/E rises from 10x to 16x while earnings grow 3% (multiple expansion drove returns, not growth). This is unsustainable. How would you distinguish between (1) genuine growth stories and (2) bubble valuations driven by foreign capital inflows?

4. **Crisis Prediction Challenge:** Using historical volatility and correlation data, design a metric to predict EM crises 3-6 months ahead. Would a simple threshold (vol > 25% + corr > 0.85) work? What false positives/negatives might occur?

5. **Diversification Within EM:** MSCI EM index is 50% China + India. Should you equally weight all 24 countries? Overweight growth winners (India)? Or wait for valuation mean reversion? What's the trade-off?

---

## 7. Key References

- **Ramos, S.B. (2009).** "Emerging Markets Crises: Recovery Patterns and the Role of Foreign Direct Investment" – Documents contagion patterns across EM crises (1997-2008).

- **Bekaert, G., Ehrmann, M., Fratzscher, M., Mehl, A. (2014).** "The Global Crisis and Equity Market Contagion" – Empirical evidence that correlation(returns) converges to 1 during crises across all market types.

- **Easterly, W. (2001).** "The Elusive Quest for Growth" – Structural analysis of why EM growth stutters despite promising fundamentals (policy reversals, political instability).

- **Chen, N.F., Roll, R., Ross, S.A. (1986).** "Economic Forces and the Stock Market" – Macroeconomic drivers of returns (inflation, growth); relevant for understanding EM risk premiums.

- **Harvey, C.R., Liu, Y., Zhu, H. (2016).** "... and the Cross-Section of Expected Returns" – Comprehensive meta-analysis showing EM as high-beta assets vulnerable to systematic downturns.

- **MSCI Emerging Markets Index** – https://www.msci.com/indexes – Real-time EM valuations, country weights, historical data.

- **JP Morgan EMBI Index** – https://www.jpmorgan.com – Emerging market bond spread data; crisis detection tool.

