"""
Extracted from: exploiting_table_selection.md
"""

import numpy as np
import matplotlib.pyplot as plt
import pandas as pd

np.random.seed(42)

print("="*70)
print("TABLE SELECTION: COMPARING BLACKJACK VENUES")
print("="*70)

# ============================================================================
# 1. CASINO DATABASE: RULE COMBINATIONS
# ============================================================================

print("\n" + "="*70)
print("1. VENUE COMPARISON MATRIX")
print("="*70)

venues = {
    'Casino A (Downtown)': {
        'decks': 6,
        's17': True,
        'das': True,
        'rsa': True,
        'payout': '3:2',
        'penetration': 0.75,
        'crowding': 'Moderate'
    },
    'Casino B (Strip)': {
        'decks': 8,
        's17': False,
        'das': False,
        'rsa': False,
        'payout': '6:5',
        'penetration': 0.60,
        'crowding': 'High'
    },
    'Casino C (Regional)': {
        'decks': 6,
        's17': True,
        'das': True,
        'rsa': False,
        'payout': '3:2',
        'penetration': 0.80,
        'crowding': 'Low'
    },
    'Casino D (Off-Strip)': {
        'decks': 8,
        's17': False,
        'das': True,
        'rsa': True,
        'payout': '3:2',
        'penetration': 0.65,
        'crowding': 'Moderate'
    },
}

# Calculate house edge for each venue
def calculate_blackjack_edge(decks, s17, das, rsa, payout):
    """Simplified blackjack edge calculation."""
    # Baseline: 6-deck, S17, DAS, RSA, 3:2 = -0.3%
    edge = -0.003
    
    # Adjustments
    if decks == 8:
        edge -= 0.001  # 8-deck is slightly worse
    
    if not s17:
        edge -= 0.002  # H17 is much worse for player
    
    if not das:
        edge -= 0.0015  # No DAS hurts
    
    if not rsa:
        edge -= 0.0008  # No RSA minor
    
    if payout == '6:5':
        edge -= 0.014  # 6:5 payout is terrible!
    
    return edge

print(f"\n{'Venue':<25} {'HE %':<10} {'Rules Quality':<20} {'Penetration':>15}")
print("=" * 70)

venue_comparison = []

for venue_name, rules in venues.items():
    edge = calculate_blackjack_edge(
        rules['decks'],
        rules['s17'],
        rules['das'],
        rules['rsa'],
        rules['payout']
    )
    
    rules_quality = (
        ('Poor' if rules['payout'] == '6:5' else 'Good') if rules['s17'] else 'Bad'
    )
    
    venue_comparison.append({
        'Venue': venue_name,
        'House Edge %': edge * 100,
        'Decks': rules['decks'],
        'Penetration': rules['penetration'] * 100,
        'Rules Quality': rules_quality,
        'Crowding': rules['crowding']
    })
    
    print(f"{venue_name:<25} {edge*100:<9.2f}% {rules_quality:<20} {rules['penetration']*100:>14.0f}%")

df_venues = pd.DataFrame(venue_comparison)
df_venues = df_venues.sort_values('House Edge %')

print(f"\n{'RANKING (Best to Worst):'}  ")
for i, row in df_venues.iterrows():
    print(f"  {i+1}. {row['Venue']}: {row['House Edge %']:.2f}% HE")

# ============================================================================
# 2. COUNTING EDGE + VENUE SELECTION
# ============================================================================

print("\n" + "="*70)
print("2. COUNTING EDGE WITH TABLE SELECTION")
print("="*70)

# Assume counter with 0.8% counting edge
counting_edge = 0.008

print(f"\nCounter skill: +{counting_edge*100:.1f}% edge (good counter)")
print(f"\nTotal edge (counting + venue selection):")
print(f"{'Venue':<25} {'House HE %':<15} {'Total Player Edge %':>20}")
print("=" * 60)

combined_edges = []

for _, row in df_venues.iterrows():
    house_he = row['House Edge %']
    total_edge = -house_he + counting_edge  # Convert HE to edge
    combined_edges.append(total_edge)
    
    edge_type = "NEGATIVE" if total_edge < 0 else "POSITIVE"
    print(f"{row['Venue']:<25} {house_he:<14.2f}% {total_edge*100:>19.2f}% ({edge_type})")

# ============================================================================
# 3. IMPACT: VENUE SELECTION ON ANNUAL PROFIT
# ============================================================================

print("\n" + "="*70)
print("3. ANNUAL PROFIT PROJECTION (by venue)")
print("="*70)

# Assumptions
hours_per_year = 500  # ~10 hours/week, 50 weeks/year
hands_per_hour = 60
bet_size = 50  # $50 average bet

print(f"\nAssumptions: {hours_per_year} hours/year, {hands_per_hour} hands/hour, ${bet_size} avg bet")

print(f"\n{'Venue':<25} {'Player Edge %':<18} {'Annual Hands':<18} {'Annual Profit':>18}")
print("=" * 79)

annual_profits = []

for _, row in df_venues.iterrows():
    house_he = row['House Edge %']
    player_edge = -house_he + counting_edge  # Net edge
    
    total_wagered = hours_per_year * hands_per_hour * bet_size
    annual_hands = hours_per_year * hands_per_hour
    annual_profit = total_wagered * player_edge
    
    annual_profits.append(annual_profit)
    
    print(f"{row['Venue']:<25} {player_edge*100:<17.2f}% {annual_hands:<18.0f} ${annual_profit:>17,.0f}")

# Opportunity cost
best_profit = max(annual_profits)
worst_profit = min(annual_profits)
opportunity_cost = best_profit - worst_profit

print(f"\n{'Opportunity Cost (Best vs Worst Venue):':} ${opportunity_cost:,.0f}/year")

# ============================================================================
# 4. PENETRATION IMPACT ANALYSIS
# ============================================================================

print("\n" + "="*70)
print("4. PENETRATION RATE IMPACT")
print("="*70)

# Simulate counting edge at different penetrations
penetrations = [0.50, 0.60, 0.70, 0.75, 0.80, 0.85]
counting_edges_by_pen = []

for pen in penetrations:
    # Counting edge improves with penetration (more cards seen)
    edge = 0.003 + (pen - 0.50) * 0.025  # Base 0.3% + improvement with depth
    counting_edges_by_pen.append(edge)

print(f"\nCounting edge by penetration rate:")
print(f"{'Penetration %':<15} {'Counting Edge %':>18}")
print("=" * 35)

for pen, edge in zip(penetrations, counting_edges_by_pen):
    print(f"{pen*100:<14.0f}% {edge*100:>17.1f}%")

penetration_swing = max(counting_edges_by_pen) - min(counting_edges_by_pen)
print(f"\nEdge swing from best to worst penetration: {penetration_swing*100:.2f}%")

# ============================================================================
# 5. VISUALIZATION
# ============================================================================

fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# Plot 1: House edge by venue
ax1 = axes[0, 0]
colors = ['green' if x < -0.003 else 'yellow' if x < 0 else 'red' for x in df_venues['House Edge %']]
ax1.barh(df_venues['Venue'], df_venues['House Edge %'], color=colors, alpha=0.7, edgecolor='black')
ax1.axvline(x=0, color='black', linestyle='-', linewidth=1)
ax1.set_xlabel('House Edge (%)')
ax1.set_title('Venue Comparison: House Edge')
ax1.grid(True, alpha=0.3, axis='x')

# Plot 2: Total player edge (with counting)
ax2 = axes[0, 1]
colors_edge = ['green' if x > 0 else 'red' for x in combined_edges]
ax2.barh(df_venues['Venue'], combined_edges, color=colors_edge, alpha=0.7, edgecolor='black')
ax2.axvline(x=0, color='black', linestyle='-', linewidth=1)
ax2.set_xlabel('Player Edge (%)')
ax2.set_title('Total Edge: Counting + Venue Selection')
ax2.grid(True, alpha=0.3, axis='x')

# Plot 3: Annual profit projection
ax3 = axes[1, 0]
colors_profit = ['green' if x > 0 else 'red' for x in annual_profits]
bars = ax3.bar(range(len(df_venues)), annual_profits, color=colors_profit, alpha=0.7, edgecolor='black')
ax3.axhline(y=0, color='black', linestyle='-', linewidth=1)
ax3.set_xticks(range(len(df_venues)))
ax3.set_xticklabels([v.split('(')[0].strip()[:10] for v in df_venues['Venue']], rotation=45, ha='right')
ax3.set_ylabel('Annual Profit ($)')
ax3.set_title('Annual Profit Projection by Venue')
ax3.grid(True, alpha=0.3, axis='y')

# Plot 4: Penetration impact
ax4 = axes[1, 1]
ax4.plot(penetrations, [e*100 for e in counting_edges_by_pen], 'o-', linewidth=2, markersize=8)
ax4.fill_between(penetrations, 0, [e*100 for e in counting_edges_by_pen], alpha=0.3)
ax4.set_xlabel('Penetration Rate (%)')
ax4.set_ylabel('Counting Edge (%)')
ax4.set_title('Counting Edge vs Penetration Rate')
ax4.grid(True, alpha=0.3)

plt.tight_layout()
plt.savefig('table_selection_analysis.png', dpi=100, bbox_inches='tight')
print("\n" + "="*70)
print("✓ Visualization saved: table_selection_analysis.png")
plt.show()

print("\n" + "="*70)
print("SUMMARY & RECOMMENDATION")
print("="*70)
best_venue = df_venues.iloc[0]
print(f"\n✓ BEST VENUE: {best_venue['Venue']}")
print(f"  - House edge: {best_venue['House Edge %']:.2f}%")
print(f"  - Penetration: {best_venue['Penetration']:.0f}%")
print(f"  - Annual profit potential: ${annual_profits[0]:,.0f}")

print(f"\n✓ VENUES TO AVOID:")
for _, row in df_venues.tail(2).iterrows():
    print(f"  - {row['Venue']}: {row['House Edge %']:.2f}% HE (opportunity cost high)")

print(f"\n✓ KEY INSIGHT:")
print(f"  - Best vs worst venue: ${opportunity_cost:,.0f}/year difference")
print(f"  - Penetration matters: {penetration_swing*100:.2f}% edge swing possible")
print(f"  - Table selection = 1-3% of total edge; don't ignore!")
